<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bloom Controls</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-user-select: none;
    }
    #box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 16px;
      min-width: 280px;
      position: relative;
      transition: all 0.3s ease;
      color: #333;
    }
    #box.collapsed {
      min-width: auto;
      width: 48px;
      height: 48px;
      padding: 12px;
      border-radius: 50%;
    }
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      cursor: move;
      padding: 4px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    #header:hover {
      background: rgba(0, 0, 0, 0.02);
    }
    #toggleBtn {
      background: rgba(0, 0, 0, 0.05);
      border: none;
      color: #666;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    #toggleBtn:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #333;
    }
    #content {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #box.collapsed #content {
      opacity: 0;
      transform: scale(0.8);
      pointer-events: none;
      position: absolute;
      visibility: hidden;
    }
    #box.collapsed #header {
      margin: 0;
      justify-content: center;
    }
    .media-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .media-btn {
      width: 48px;
      height: 48px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s;
      position: relative;
    }
    .camera-btn {
      background: #f0f0f0;
      color: #666;
    }
    .camera-btn.active {
      background: #007AFF;
      color: white;
    }
    .camera-btn:hover {
      background: #e0e0e0;
    }
    .camera-btn.active:hover {
      background: #0056CC;
    }
    .screenshot-btn {
      background: #f0f0f0;
      color: #666;
    }
    .screenshot-btn:hover {
      background: #e0e0e0;
    }
    .home-btn {
      background: #f0f0f0;
      color: #666;
    }
    .home-btn:hover {
      background: #e0e0e0;
    }
    .screen-mode {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 12px;
    }
    .screen-icon {
      font-size: 16px;
    }
    .screen-label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      flex: 1;
    }
    .camera-section {
      margin-bottom: 16px;
    }
    .camera-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .camera-icon {
      font-size: 16px;
      color: #666;
    }
    .camera-status {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }
    .camera-status.off {
      color: #999;
    }
    .camera-toggle {
      margin-left: auto;
      width: 48px;
      height: 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    .camera-toggle.off {
      background: #ddd;
    }
    .camera-toggle.on {
      background: #007AFF;
    }
    .camera-toggle::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      top: 2px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .camera-toggle.off::after {
      left: 2px;
    }
    .camera-toggle.on::after {
      left: 26px;
    }
    .camera-dropdown {
      margin-top: 8px;
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      transition: all 0.2s;
    }
    .camera-dropdown:hover {
      border-color: #007AFF;
    }
    .camera-dropdown:focus {
      outline: none;
      border-color: #007AFF;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    .camera-dropdown option {
      padding: 8px;
    }
    .microphone-section {
      margin-bottom: 16px;
    }
    .microphone-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .microphone-icon {
      font-size: 16px;
      color: #007AFF;
    }
    .microphone-label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }
    .microphone-status {
      margin-left: auto;
      font-size: 12px;
      color: #007AFF;
      background: rgba(0, 122, 255, 0.1);
      padding: 4px 8px;
      border-radius: 12px;
    }
    .recording-section {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    .record-btn {
      width: 64px;
      height: 64px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.2s;
      background: #ff4757;
      color: white;
      position: relative;
    }
    .record-btn:hover {
      background: #ff3838;
      transform: scale(1.05);
    }
    .record-btn.recording {
      background: #ff4757;
      animation: pulse 2s infinite;
    }
    .record-btn.recording::after {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      border: 2px solid #ff4757;
      border-radius: 50%;
      opacity: 0.3;
      animation: ripple 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes ripple {
      0% { transform: scale(1); opacity: 0.3; }
      100% { transform: scale(1.2); opacity: 0; }
    }
    .recording-time {
      text-align: center;
      font-size: 12px;
      color: #ff4757;
      font-weight: 500;
      margin-top: 8px;
    }
    .lock-section {
      margin-bottom: 16px;
    }
    .lock-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .lock-icon {
      font-size: 16px;
      color: #666;
    }
    .lock-label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      flex: 1;
    }
    .lock-toggle {
      margin-left: auto;
      width: 48px;
      height: 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    .lock-toggle.off {
      background: #ddd;
    }
    .lock-toggle.on {
      background: #007AFF;
    }
    .lock-toggle::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      top: 2px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .lock-toggle.off::after {
      left: 2px;
    }
    .lock-toggle.on::after {
      left: 26px;
    }
    .resize-section {
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(0, 122, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(0, 122, 255, 0.1);
    }
    .resize-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .resize-icon {
      font-size: 16px;
      color: #007AFF;
    }
    .resize-label {
      font-size: 14px;
      font-weight: 600;
      color: #007AFF;
      flex: 1;
    }
    .resize-controls {
      display: flex;
      gap: 6px;
      justify-content: space-between;
    }
    .resize-btn {
      flex: 1;
      height: 36px;
      border: 2px solid #007AFF;
      border-radius: 8px;
      background: white;
      color: #007AFF;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .resize-btn:hover {
      border-color: #0056CC;
      background: rgba(0, 122, 255, 0.1);
      color: #0056CC;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 122, 255, 0.2);
    }
    .resize-btn.active {
      background: #007AFF;
      color: white;
      border-color: #007AFF;
      box-shadow: 0 2px 4px rgba(0, 122, 255, 0.3);
    }
    .custom-resize {
      font-size: 16px;
      min-width: 36px;
      flex: 0;
    }
    .status {
      text-align: center;
      font-size: 11px;
      color: #999;
      background: rgba(0, 0, 0, 0.03);
      padding: 8px;
      border-radius: 8px;
      margin-top: 8px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="box">
    <div id="header">
      <button id="toggleBtn" title="Toggle controls">√ó</button>
    </div>
    
    <div id="content">
      <!-- Media Controls -->
      <div class="media-controls">
        <button class="media-btn camera-btn" id="cameraBtn" title="Camera">
          üìπ
        </button>
        <button class="media-btn screenshot-btn" id="screenshotBtn" title="Screenshot">
          üì∑
        </button>
        <button class="media-btn home-btn" id="homeBtn" title="Home">
          üè†
        </button>
      </div>

      <!-- Full Screen Mode -->
      <div class="screen-mode">
        <span class="screen-icon">üíª</span>
        <span class="screen-label">Full screen</span>
      </div>

      <!-- Camera Section -->
      <div class="camera-section">
        <div class="camera-header">
          <span class="camera-icon">üìπ</span>
          <span class="camera-status" id="cameraStatus">No Camera</span>
          <button class="camera-toggle off" id="cameraToggle"></button>
        </div>
        <select class="camera-dropdown" id="cameraSelect" style="display: none;">
          <option value="">Select Camera...</option>
        </select>
      </div>

      <!-- Microphone Section -->
      <div class="microphone-section">
        <div class="microphone-header">
          <span class="microphone-icon">üé§</span>
          <span class="microphone-label">Default - MacBook Pro Microphone</span>
          <span class="microphone-status">On</span>
        </div>
      </div>

      <!-- Recording Section -->
      <div class="recording-section">
        <button class="record-btn" id="recordBtn" title="Start Recording">
          ‚è∫
        </button>
      </div>
      <div class="recording-time hidden" id="recordingTime">5 min recording limit</div>

      <!-- Lock Toggle Section -->
      <div class="lock-section">
        <div class="lock-header">
          <span class="lock-icon">üîí</span>
          <span class="lock-label">Lock Position</span>
          <button class="lock-toggle off" id="lockToggle"></button>
        </div>
      </div>

      <!-- Resize Controls Section -->
      <div class="resize-section" style="border: 2px solid #007AFF; background: rgba(0, 122, 255, 0.1);">
        <div class="resize-header">
          <span class="resize-icon">üìè</span>
          <span class="resize-label">WEBCAM SIZE</span>
        </div>
        <div class="resize-controls">
          <button class="resize-btn" id="resizeSmall" title="Small">SMALL</button>
          <button class="resize-btn" id="resizeMedium" title="Medium">MED</button>
          <button class="resize-btn" id="resizeLarge" title="Large">LARGE</button>
          <button class="resize-btn custom-resize" id="resizeCustom" title="Drag to resize">‚§°</button>
        </div>
      </div>

      <div class="status" id="status">Camera issue detected</div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require("electron");
    const cameraSelect = document.getElementById("cameraSelect");
    const cameraBtn = document.getElementById("cameraBtn");
    const cameraStatus = document.getElementById("cameraStatus");
    const cameraToggle = document.getElementById("cameraToggle");
    const lockToggle = document.getElementById("lockToggle");
    const recordBtn = document.getElementById("recordBtn");
    const recordingTime = document.getElementById("recordingTime");
    const status = document.getElementById("status");
    const toggleBtn = document.getElementById("toggleBtn");
    const box = document.getElementById("box");
    const resizeSmall = document.getElementById("resizeSmall");
    const resizeMedium = document.getElementById("resizeMedium");
    const resizeLarge = document.getElementById("resizeLarge");
    const resizeCustom = document.getElementById("resizeCustom");
    
    let isOverlayActive = false;
    let isCollapsed = false;
    let isRecording = false;
    let isCameraOn = false;
    let isLocked = false; // Changed default to false (unlocked)
    let recordingInterval;
    let recordingStartTime;
    let currentSize = 'medium'; // Track current size

    // Drag functionality for controls window
    let dragging = false, dragOffsetX = 0, dragOffsetY = 0;

    // Make the header the primary drag handle
    const header = document.getElementById("header");
    header.addEventListener("mousedown", (e) => {
      if (isLocked) return; // Don't drag when locked
      if (isCollapsed) return; // Don't drag when collapsed (too small)
      
      // Don't start drag if clicking the toggle button
      if (e.target.id === 'toggleBtn') {
        return;
      }
      
      dragging = true;
      dragOffsetX = e.clientX;
      dragOffsetY = e.clientY;
      e.preventDefault();
    });

    // Also allow dragging from the main box area (avoiding interactive elements)
    box.addEventListener("mousedown", (e) => {
      if (isLocked) return;
      if (isCollapsed) return;
      
      // Don't start drag on interactive elements
      if (e.target.tagName === 'BUTTON' || 
          e.target.tagName === 'SELECT' || 
          e.target.tagName === 'OPTION' ||
          e.target.closest('#header')) { // Skip if already handled by header
        return;
      }
      
      dragging = true;
      dragOffsetX = e.clientX;
      dragOffsetY = e.clientY;
      e.preventDefault();
    });

    window.addEventListener("mousemove", (e) => {
      if (!dragging) return;
      // Calculate new position based on screen coordinates
      const newX = e.screenX - dragOffsetX;
      const newY = e.screenY - dragOffsetY;
      ipcRenderer.send("move-controls", newX, newY);
    });

    window.addEventListener("mouseup", () => {
      dragging = false;
    });

    // Toggle collapse/expand
    toggleBtn.addEventListener("click", () => {
      isCollapsed = !isCollapsed;
      if (isCollapsed) {
        box.classList.add("collapsed");
        toggleBtn.textContent = "‚ñ∂";
        toggleBtn.title = "Expand controls";
        ipcRenderer.send("resize-controls", 48, 48);
      } else {
        box.classList.remove("collapsed");
        toggleBtn.textContent = "√ó";
        toggleBtn.title = "Collapse controls";
        ipcRenderer.send("resize-controls", 320, 500);
      }
    });

    // Load available cameras
    async function loadCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        cameraSelect.innerHTML = '<option value="">Select Camera...</option>';
        if (videoDevices.length === 0) {
          cameraStatus.textContent = "No Camera";
          cameraStatus.classList.add("off");
          cameraToggle.disabled = true;
          status.textContent = "No cameras available";
          return;
        }
        
        videoDevices.forEach((device, index) => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.textContent = device.label || `Camera ${index + 1}`;
          cameraSelect.appendChild(option);
        });
        
        // Set first camera as default
        if (videoDevices.length > 0) {
          cameraSelect.value = videoDevices[0].deviceId;
          cameraStatus.textContent = videoDevices[0].label || "Camera 1";
          cameraStatus.classList.remove("off");
          status.textContent = "Ready to record";
        }
      } catch (err) {
        console.error("Error loading cameras:", err);
        cameraStatus.textContent = "Camera Error";
        cameraStatus.classList.add("off");
        status.textContent = "Camera issue detected";
        cameraToggle.disabled = true;
      }
    }

    // Camera toggle
    cameraToggle.addEventListener("click", () => {
      if (cameraToggle.disabled) return;
      
      isCameraOn = !isCameraOn;
      
      if (isCameraOn) {
        cameraToggle.classList.remove("off");
        cameraToggle.classList.add("on");
        cameraBtn.classList.add("active");
        cameraSelect.style.display = "block";
        
        const selectedCamera = cameraSelect.value;
        if (selectedCamera) {
          ipcRenderer.send("start-overlay", selectedCamera);
          isOverlayActive = true;
          status.textContent = "Camera active";
        }
      } else {
        cameraToggle.classList.remove("on");
        cameraToggle.classList.add("off");
        cameraBtn.classList.remove("active");
        cameraSelect.style.display = "none";
        
        if (isOverlayActive) {
          ipcRenderer.send("stop-overlay");
          isOverlayActive = false;
        }
        status.textContent = "Camera off";
      }
    });

    // Camera selection change
    cameraSelect.addEventListener("change", () => {
      if (isCameraOn && cameraSelect.value) {
        ipcRenderer.send("stop-overlay");
        setTimeout(() => {
          ipcRenderer.send("start-overlay", cameraSelect.value);
          status.textContent = "Camera switched";
        }, 100);
      }
      
      if (cameraSelect.value) {
        const selectedOption = cameraSelect.options[cameraSelect.selectedIndex];
        cameraStatus.textContent = selectedOption.textContent;
      }
    });

    // Lock toggle
    lockToggle.addEventListener("click", () => {
      isLocked = !isLocked;
      
      if (isLocked) {
        lockToggle.classList.remove("off");
        lockToggle.classList.add("on");
      } else {
        lockToggle.classList.remove("on");
        lockToggle.classList.add("off");
      }
      
      ipcRenderer.send("set-lock", isLocked);
    });

    // Resize controls
    function updateResizeButtons(activeButton) {
      const buttons = [resizeSmall, resizeMedium, resizeLarge];
      buttons.forEach(btn => btn.classList.remove("active"));
      if (activeButton) {
        activeButton.classList.add("active");
      }
    }

    resizeSmall.addEventListener("click", () => {
      currentSize = 'small';
      updateResizeButtons(resizeSmall);
      ipcRenderer.send("resize-overlay", 200, 200);
      status.textContent = "Webcam resized to small";
    });

    resizeMedium.addEventListener("click", () => {
      currentSize = 'medium';
      updateResizeButtons(resizeMedium);
      ipcRenderer.send("resize-overlay", 320, 320);
      status.textContent = "Webcam resized to medium";
    });

    resizeLarge.addEventListener("click", () => {
      currentSize = 'large';
      updateResizeButtons(resizeLarge);
      ipcRenderer.send("resize-overlay", 480, 480);
      status.textContent = "Webcam resized to large";
    });

    resizeCustom.addEventListener("click", () => {
      currentSize = 'custom';
      updateResizeButtons(null);
      if (isCameraOn) {
        status.textContent = "Drag the resize handle on webcam to resize";
      } else {
        status.textContent = "Turn on camera to see resize handle";
      }
    });

    // Set initial medium size as active
    updateResizeButtons(resizeMedium);
    
    // Debug: Log that resize controls are initialized
    console.log("Resize controls initialized:", {
      small: resizeSmall,
      medium: resizeMedium,
      large: resizeLarge,
      custom: resizeCustom
    });

    // Start/Stop recording
    recordBtn.addEventListener("click", () => {
      if (!isRecording) {
        // Start recording
        isRecording = true;
        recordBtn.classList.add("recording");
        recordBtn.textContent = "‚èπ";
        recordBtn.title = "Stop Recording";
        recordingTime.classList.remove("hidden");
        
        recordingStartTime = Date.now();
        recordingInterval = setInterval(updateRecordingTime, 1000);
        
        ipcRenderer.send("start-recording");
        status.textContent = "Recording...";
      } else {
        // Stop recording
        stopRecording();
        ipcRenderer.send("stop-recording");
      }
    });

    function stopRecording() {
      isRecording = false;
      recordBtn.classList.remove("recording");
      recordBtn.textContent = "‚è∫";
      recordBtn.title = "Start Recording";
      recordingTime.classList.add("hidden");
      
      if (recordingInterval) {
        clearInterval(recordingInterval);
        recordingInterval = null;
      }
      
      status.textContent = "Recording saved";
      setTimeout(() => {
        status.textContent = isCameraOn ? "Camera active" : "Ready to record";
      }, 2000);
    }

    function updateRecordingTime() {
      if (!isRecording) return;
      
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      const remaining = Math.max(0, 300 - elapsed); // 5 minute limit
      const remainingMinutes = Math.floor(remaining / 60);
      const remainingSeconds = remaining % 60;
      
      recordingTime.textContent = `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')} remaining`;
      
      if (remaining <= 0) {
        stopRecording();
        ipcRenderer.send("stop-recording");
      }
    }

    // Handle overlay status updates from main process
    ipcRenderer.on("overlay-status", (_, active) => {
      isOverlayActive = active;
      if (!active && isCameraOn) {
        // Camera was turned off externally
        isCameraOn = false;
        cameraToggle.classList.remove("on");
        cameraToggle.classList.add("off");
        cameraBtn.classList.remove("active");
        cameraSelect.style.display = "none";
        status.textContent = "Camera off";
      }
    });

    // Handle recording status updates
    ipcRenderer.on("recording-status", (_, recording) => {
      if (!recording && isRecording) {
        stopRecording();
      }
    });

    // Handle recording saved notification
    ipcRenderer.on("recording-saved", (_, filePath) => {
      status.textContent = `Recording saved to Desktop`;
    });

    // Handle recording errors
    ipcRenderer.on("recording-error", (_, error) => {
      status.textContent = `Recording error: ${error}`;
      if (isRecording) {
        stopRecording();
      }
    });

    // Handle when user ends recording via system controls
    ipcRenderer.on("recording-ended-by-user", () => {
      if (isRecording) {
        stopRecording();
      }
    });

    // Handle lock state changes from main process
    ipcRenderer.on("lock-changed", (_, locked) => {
      isLocked = !!locked;
      if (isLocked) {
        lockToggle.classList.remove("off");
        lockToggle.classList.add("on");
      } else {
        lockToggle.classList.remove("on");
        lockToggle.classList.add("off");
      }
    });

    // Load cameras when page loads
    loadCameras();

    // Reload cameras when devices change
    navigator.mediaDevices.addEventListener('devicechange', loadCameras);
  </script>
</body>
</html>
